---
output: github_document
---

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "docs/"
)
```

[![saythanks](https://img.shields.io/badge/say-thanks-ff69b4.svg)](https://saythanks.io/to/robsalasco)
[![Donate](https://img.shields.io/badge/donate-paypal-green.svg)](https://www.paypal.com/cgi-bin/webscr?cmd=_donations&business=WDDLRUVD344XL&currency_code=USD&source=url)
[![Travis-CI Build Status](https://travis-ci.org/robsalasco/sinimr.svg?branch=master)](https://travis-ci.org/robsalasco/sinimr)
[![AppVeyor Build Status](https://ci.appveyor.com/api/projects/status/github/robsalasco/sinimr?branch=master&svg=true)](https://ci.appveyor.com/project/robsalasco/sinimr)
[![Coverage Status](https://img.shields.io/codecov/c/github/robsalasco/sinimr/master.svg)](https://codecov.io/github/robsalasco/sinimr?branch=master)

# sinimR <img src="docs/sinimR_hexSticker.png" width = "175" height = "200" align="right" /> 

Chilean Municipalities Information System Wrapper

### What can I do with this?

This R package allows easy SINIM (http://sinim.gov.cl) data retrieval what have advantages over the site:

- When you work with multiple variables or years it will be very useful for rapid analyses.
- Fast ploting directly from data source using the included geometries.
- Data download with or without monetary correction using a switch.

```{r, message=F, fig.height=10, fig.width=10, fig.retina=2}
library(tmap)
library(dplyr)
library(stringr)
library(sinimr)
library(sf)

data_sinim <- get_sinim(var = c(3954,4174,880,1226,4251,4173), 
                        year = 2018, 
                        geometry = T, 
                        unit = "limites", 
                        region = "13",
                        truevalue = T)

comunas <- c("CERRILLOS", "LA REINA", "PUDAHUEL", "CERRO NAVIA", "LAS CONDES",
             "QUILICURA", "CONCHALÍ", "LO BARNECHEA", "QUINTA NORMAL", "EL BOSQUE",
             "LO ESPEJO", "RECOLETA", "ESTACIÓN CENTRAL", "LO PRADO", "RENCA", "HUECHURABA",
             "MACUL", "SAN MIGUEL", "INDEPENDENCIA", "MAIPÚ", "SAN JOAQUÍN", "LA CISTERNA", "ÑUÑOA",
             "SAN RAMÓN", "LA FLORIDA", "PEDRO AGUIRRE CERDA", "SANTIAGO", "LA PINTANA", "PEÑALOLÉN",
             "VITACURA", "LA GRANJA", "PROVIDENCIA", "SAN BERNARDO", "PUENTE ALTO", "PADRE HURTADO", "PIRQUE",
             "SAN JOSÉ DE MAIPO")

var <- data_sinim %>% filter(MUNICIPALITY %in% comunas)

namevar <- var %>% select(-MUNICIPALITY,-CODE) %>% st_set_geometry(NULL) %>% names() 

sd <- tm_shape(var) +
  tm_fill(col = namevar,
          palette = "BuPu", 
          border.col = "white", 
          border.alpha = 0.5,
          lwd=1,
          style = "pretty",
          title = namevar %>% stringr::str_remove("\\.\\d+"))+
  tm_text("MUNICIPALITY", size = 0.4) +
  tm_style("white", frame = T, legend.title.size = 1, legend.width=1) +
  tm_layout(inner.margins = c(0.01, 0.15, 0.15, 0.01),
            outer.margins = c(0, 0.01, 0.01, 0),
            design.mode=F,
            legend.format = list(text.separator = "a",
                                 fun = function(x) paste0(formatC(x/1e9, digits = 0, format = "f"), " mm$")))+
  tm_compass(type = "8star", position = c(.85, .80)) +
  tm_borders(col = 'black')

sd

```

### Support

FONDECYT Regular 2016 Nº 1161417, ¿Quién es responsable del desarrollo local? Una geografía política del neoestructuralismo en "comunas de exportación" (Comisión Nacional de Investigación Científica y Tecnológica).

### A note on usage

When querying the API, please be respectful of the resources required to provide this data. Please retain the results for each request to avoid repeated requests for duplicate information.

### Installation

```R
install.packages("devtools")
devtools::install_github("robsalasco/sinimr")
```

### How do I use it?

sinimR comes with a small set of functions to deliver the content of SINIM's webpage. To get a first glance of the categories of information what are available please use the ```get_sinim_cats()``` command.

```{r}
library(sinimr)
get_sinim_cats()
```

Every category have a bunch of variables associated. Use the CODE number and the ```get_sinim_vars()``` function to get them.

```{r}
get_sinim_vars(517)
```

Finally, to obtain the data across municipalities use the code column and specify a year.

```{r}
head(get_sinim(c(4210,4211),2015))
```

You can get multiple years too! use the command ```get_sinim()``` and add more years as in the example.

```{r}
head(get_sinim(880,2015:2017))
```

The geometries are available using the ```geometry==T``` argument.

```{r}
head(get_sinim(882,2015:2017, geometry=T))
```

If you don't know what are you looking for use ```search_sinim_vars()```to get search results based on variable descriptions, names and groups.

```{r}
search_sinim_vars("cementerio")
```

On advanced usage please have a look in the documentation included.

### Other example plots

```{r, message=F, fig.height=8, fig.width=8, fig.retina=2}
library(dplyr)
library(sinimr)
library(sf)
library(tmap)

comunas <- c("CERRILLOS", "LA REINA", "PUDAHUEL", "CERRO NAVIA", "LAS CONDES",
             "QUILICURA", "CONCHALÍ", "LO BARNECHEA", "QUINTA NORMAL", "EL BOSQUE",
             "LO ESPEJO", "RECOLETA", "ESTACIÓN CENTRAL", "LO PRADO", "RENCA", "HUECHURABA",
             "MACUL", "SAN MIGUEL", "INDEPENDENCIA", "MAIPÚ", "SAN JOAQUÍN", "LA CISTERNA", "ÑUÑOA",
             "SAN RAMÓN", "LA FLORIDA", "PEDRO AGUIRRE CERDA", "SANTIAGO", "LA PINTANA", "PEÑALOLÉN",
             "VITACURA", "LA GRANJA", "PROVIDENCIA", "SAN BERNARDO", "PUENTE ALTO", "PADRE HURTADO", "PIRQUE",
             "SAN JOSÉ DE MAIPO")

var <- get_sinim(882, 2018, truevalue = T, geometry = T, unit = "limites") %>% filter(MUNICIPALITY %in% comunas)

reg.13.plot <- tm_shape(var) +
  tm_polygons(names(var)[3], palette="magma", border.col = "white") +
  tm_text(names(var)[2], size = 0.4, style="jenks") +
  tm_legend(legend.position = c("left", "top")) +
  tm_compass(type = "8star", position = c("right", "top")) +
  tm_scale_bar(breaks = c(0, 10), size = 0.75, position = c("right", "bottom"), width = 1) +
  tm_credits("Fuente: Sistema Nacional de Información Municipal (SINIM), SUBDERE, Ministerio del Interior.", position=c("left", "bottom"), size=0.55)+
  tm_layout(inner.margins = c(0.1, 0.1, 0.10, 0.01), legend.format = list(text.separator = "a", fun = function(x) paste0(formatC(x/1e9, digits = 0, format = "f"), " mm$")))

reg.13.plot

```

```{r, message=F, fig.height=12, fig.width=24, fig.retina=2}
library(sf)
library(dplyr)
library(geofacet)
library(sinimr)
library(ggplot2)
library(zoo)
library(scales)
library(ggpubr)

comunas <- c("CERRILLOS", "LA REINA", "PUDAHUEL", "CERRO NAVIA", "LAS CONDES",
             "QUILICURA", "CONCHALÍ", "LO BARNECHEA", "QUINTA NORMAL", "EL BOSQUE",
             "LO ESPEJO", "RECOLETA", "ESTACIÓN CENTRAL", "LO PRADO", "RENCA", "HUECHURABA",
             "MACUL", "SAN MIGUEL", "INDEPENDENCIA", "MAIPÚ", "SAN JOAQUÍN", "LA CISTERNA", "ÑUÑOA",
             "SAN RAMÓN", "LA FLORIDA", "PEDRO AGUIRRE CERDA", "SANTIAGO", "LA PINTANA", "PEÑALOLÉN",
             "VITACURA", "LA GRANJA", "PROVIDENCIA", "SAN BERNARDO", "PUENTE ALTO", "PADRE HURTADO", "PIRQUE",
             "SAN JOSÉ DE MAIPO")

data <- get_sinim(882,2002:2018, moncorr = F) %>% filter(MUNICIPALITY %in% comunas)
data[5] <- data[5]*1000
data$YEAR <- as.numeric(as.character(data$YEAR))
data$YEAR <- as.Date(as.yearmon(data$YEAR, "1-%y"))

reg13 <- geogrid::read_polygons("https://raw.githubusercontent.com/robsalasco/precenso_2016_geojson_chile/master/Extras/GRAN_SANTIAGO.geojson")
grd <- grid_auto(reg13, seed = 1, names = "NOM_COMUNA", codes = "COMUNA")

#grid_preview(grd, label = "name_NOM_COMUNA")
#grid_design(grd, label = "name_NOM_COMUNA")

ggplot(data, aes(YEAR, VALUE, group=1)) +
  geom_line(color = "steelblue") +
  facet_geo(~ MUNICIPALITY, grid = grd, scales = "free_y")+
  scale_x_date() +
  scale_y_continuous(labels = dollar_format(suffix = "", prefix = "$", big.mark = ".", decimal.mark=","))+
  theme_bw()
```


### Citation

```{r}
citation("sinimr")
```

### References

- Sistema Nacional de Información Municipal (SINIM), SUBDERE, Ministerio del Interior.

